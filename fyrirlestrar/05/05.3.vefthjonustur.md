---
title: Fyrirlestur 5.3 ‚Äî Vef√æj√≥nustur
---

# Fyrirlestur 5.3 ‚Äî Vef√æj√≥nustur

## Vefforritun 2 ‚Äî HBV403G

### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## H√∂nnun √° vef√æj√≥nustum

* T√∂luvert √≥l√≠kt √æv√≠ a√∞ hanna vefi me√∞ √∫tliti
* Neytendur okkar eru a√∞rir forritarar og √æeirra forrit
  - Mun minna r√Ωmi til a√∞ t√∫lka eitthva√∞ eins og villu √° vef
  - Getum spara√∞ √∂√∞rum _√≥tr√∫lega_ mikinn t√≠ma me√∞ √æv√≠ a√∞ vanda okkur

***

* √ûurfum a√∞ hugsa vel um samr√¶mi
  - Samr√¶mi √° heitum (ekki `username`, `userName` og `user-name`)
  - Samr√¶mi √° URI (ekki `/get-users`, `/products` og `/cats`)
  - Samr√¶mi √° villuskilabo√∞um

***

* Hugsum heildst√¶tt, hva√∞ gerist √≠ hverju tilfelli?
  - Hva√∞ ef be√∞i√∞ er um eitthva√∞ sem er ekki til
  - Hva√∞ ef villa kemur upp
  - o.s.fr.
* Oft gott a√∞ a√∞skilja virknina okkar fr√° vef√æj√≥nustulaginu
  - Vef√æj√≥nustan kemur sem ‚Äû√æunnt lag‚Äú ofan √° virkni

***

## D√¶mi

* [app-api](daemi/ws/app-api/)

---

## D√Ωnam√≠skar fyrirspurnir

* Stundum √æurfum vi√∞ a√∞ gr√≠pa til √æess a√∞ b√∫a til fyrirspurnir me√∞ strengjame√∞h√∂ndlun üôà
* Ekki allt getur fari√∞ √≠ prepared statement, t.d. ef vi√∞ viljum d√Ωnam√≠skt breyta `ORDER BY`
* E√∞a gera `PATCH` k√∂ll
* **VER√êUM A√ê FARA VARLEGA**, svona k√≥√∞i er einstaklega vi√∞kv√¶mur fyrir SQL injection

***

<!-- eslint-disable no-unused-vars, no-undef -->

```javascript
async function list(req, res) {
  const asc = req.query.order === 'ASC';

  // r√∂√∞um e. id √≠ ascending (ASC) e√∞a
  // descending (DESC) r√∂√∞ eftir √æv√≠
  // hvort boolean gildi s√© satt e√∞a ekki
  // Notum ekkert fr√° notanda √≠ d√Ωnam√≠skr√≠
  // fyrirsp. GETUM A√êEINS HAFT TV√ñ GILDI!
  const order = asc ? 'id ASC' : 'id DESC';

  const q = `
    SELECT * FROM items ORDER BY ${order}`;

  const result = await query(q);
}
```

***

## F√¶rslur b√∫nar til

* Getum nota√∞ `RETURNING` syntax √≠ postgres til a√∞ f√° til baka f√¶rslu sem b√∫in var til
* √ûurfum ekki a√∞ra fyrirspurn til a√∞ fletta upp reitum eins og `id` e√∞a `created`
* `INSERT INTO items (text) VALUES ('foo') RETURNING id, text, created;`

***

## F√¶rslum eytt

* Getum reynt a√∞ ey√∞a f√¶rslu sem er ekki til
  - √ûurfum samt a√∞ a√∞skilja √° milli f√¶rslu sem var til og eytt
  - og f√¶rslu sem var ekki til...
* √ûegar √°tt var vi√∞ ra√∞ir mun `rowCount` skila fj√∂lda ra√∞a sem √°tt var vi√∞

***

<!-- eslint-disable no-unused-vars, no-undef -->

```javascript
async function deleteRow(id) {
  const q = `
    DELETE FROM todos WHERE id = $1`;

  const result = await query(q, [id]);

  // true ef f√¶rslu eytt, annars false
  return result.rowCount === 1;
}
```

---

## Paging

* √ûegar vi√∞ erum a√∞ vinna me√∞ miki√∞ af g√∂gnum √æurfum vi√∞ oft √° t√≠√∞um a√∞ takmarka hversu miklu er skila√∞
* Ekki v√¶nlegt a√∞ skila √∂llum _milj√≥n_ f√¶rslum til notanda
* Yfirleitt √∫tf√¶rt me√∞ √æv√≠ a√∞ skila _s√≠√∞um_

***

## S√≠√∞ur

* S√≠√∞ur takmarkast af fj√∂lda f√¶rslna per s√≠√∞u (`limit`) og hve m√∂rgum vi√∞ sleppum (`offset`)
  - `limit=10, offset=10` birtir f√¶rslur 11-20
* Einnig h√¶gt a√∞ einfalda √≠ `page`, h√∂fum √æ√° skilgreindan fj√∂lda per s√≠√∞u og `page` er margf√∂ldun √° honum
  - `page=1` eru f√¶rslur 1-10, `page=4` eru f√¶rslur 31-40

***

## Uppl√Ωsingar um s√≠√∞u

* Getum skila√∞ uppl√Ωsingum um s√≠√∞u √≠ svari e√∞a header
* [RFC 5988](https://tools.ietf.org/html/rfc5988) skilgreinir _web linking_ og hvernig nota megi √≠ hausum
  - `Link: <http://api.example.com/?page=1>; rel="previous", <http://api.example.com/?page=3>; rel="next",`

***

* Getur veri√∞ einfaldara a√∞ skila √≠ svari, h√¶gt a√∞ nota `_link` sem er skilgreint √≠ [HAL](https://en.wikipedia.org/wiki/Hypertext_Application_Language)

***

```json
{
  "_links": {
    "self": {
      "href": "http://api.example.com/?page=2"
    },
    "previous": {
      "href": "http://api.example.com/?page=1"
    },
    "next": {
      "href": "http://api.example.com/?page=3"
    }
  },
  "items": []
}
```

***

## S√≠√∞ur og postgres

* Getum sent `offset` og `limit` √≠ postgres query
* `SELECT * FROM foo OFFSET 0 LIMIT 10`
  - Sendum sem parameterized gildi

***

## D√¶mi

* [paging](daemi/ws/paging/)

---

## Leit

* Me√∞ st√≥rum gagnasettum fylgir of einnig √æ√∂rf til a√∞ geta leita√∞ √≠ √æeim
* Nokkrar lei√∞ir m√∂gulegar

***

## Table scan

* Fyrsta lausn sem manni g√¶ti dotti√∞ √≠ hug v√¶ri a√∞ nota `LIKE` leit √≠ gagnagrunni
* Veljum d√°lka til a√∞ leita √≠ og setjum leitarskilyr√∞i inn me√∞ `%`
  - `... WHERE description LIKE '%foo%'`
* Afskaplega sl√¶m lausn √æar sem fyrir hvert skilyr√∞i √æarf a√∞ sko√∞a alla d√°lka √≠ t√∂flu

***

![Graf sem s√Ωnir hvernig allt s√© hratt fyrir l√≠ti√∞ n](img/smalln.png)

***

## Index

* Getum √æ√° √∫tb√∫i√∞ _index_ fyrir t√∂flu, veljum einhverja d√°lka og geymum √æ√° s√©rstaklega
* Til s√©rst√∂k lausn √° √æessu me√∞ _full-text index_, allur texti settur √≠ index og leita√∞ s√©rstaklega √≠ honum
  - Getur √æurft s√©rstaka uppsetningu √≠ gagnagrunni

***

## Leitar√æj√≥nusta

* √ñnnur algeng lausn er algj√∂rlega a√∞skilinn leitar√æj√≥nusta
* Tengjum g√∂gnin √≠ okkar gagnagrunn vi√∞ leitar√æj√≥nustu, t.d. me√∞ reglulegum keyrslum e√∞a _triggers_
* B√≠√∞ur upp √° s√©rh√¶f√∞a leit me√∞ setningarfr√¶√∞i og √°l√≠ka
* T.d. elasticsearch e√∞a algolia

***

## Leit √≠ postgres

* [Postgres b√≠√∞ur upp √° a√∞ leita √°n index](https://www.postgresql.org/docs/current/textsearch-tables.html)
* Leitar m.t.t. m√°lfr√¶√∞i ef h√∫n er skilgreind √≠ postgres
  - Enska er sj√°lfgefi√∞ uppsett

***

* Skilgreinum √≠ hva√∞a d√°lk vi√∞ leitum og eftir hverju vi√∞ leitum
  - `to_tsvector` og `to_tsquery`
* `to_tsquery` getur teki√∞ vi√∞ breytum og syntax, getum lent √≠ a√∞ f√° villur
  - `plainto_tsquery` leitar bara

***

```sql
SELECT title
FROM pgweb
WHERE
  to_tsvector('english', body)
  @@
  to_tsquery('english', 'friend');
```

***

## D√¶mi

* [Search](daemi/ws/search/)

---

## Gagnam√≥del

* √ûegar vi√∞ setjum upp t√∂flur √≠ gagnagrunn √æurfum vi√∞ a√∞ hugsa um hva√∞a verkefni vi√∞ erum a√∞ leysa
* Hvernig _gagnam√≥deli√∞_ (e. data model) okkar l√≠tur √∫t 
  * Erum a√∞ √∫tb√∫a einfalda√∞a birtingarmynd af raunveruleikanum
* √ûurfum a√∞ √∫tb√∫a tengingar √° milli taflna

***

## One-to-one

* One-to-one tengingar eiga vi√∞ √æegar eining √° tengingu vi√∞ n√°kv√¶mlega eina a√∞ra einingu
* S√∫ eining √° tengingu til baka √≠ a√∞eins √æ√° einingu
* T.d. h√∂fu√∞borg ‚Üî land, √≠slensk kennitala ‚Üî √≠slenskur r√≠kisborgari

***

## One-to-many

* One-to-many √° vi√∞ √æegar eining √° tengingu vi√∞ n√°kv√¶mlega eina a√∞ra einingu
* S√∫ eining getur √°tt tengingar vi√∞ margar einingar
* T.d. b√≥k √° margar bla√∞s√≠√∞ur, en bla√∞s√≠√∞urnar eiga a√∞eins eina b√≥k
* Einnig h√¶gt a√∞ sn√∫a vi√∞ og m√≥dela sem many-to-one

***

* √ç gagnagrunni notum vi√∞ v√≠sun √∫r einni t√∂flu √≠ a√∞ra til a√∞ m√≥dela √æessar tenginar
* √û√≥ getur one-to-one veri√∞ ‚Äûbroti√∞‚Äú √° √æennan m√°ta √æar sem vi√∞ getum mynda√∞ one-to-many tengingu
  * Oft eru g√∂gnin hreinlega saman √≠ einni t√∂flu, t.d. nafn og kennitala

***

* Vi√∞ tryggjum tenginguna me√∞ √æv√≠ a√∞ skilgreina _foreign key_ √° milli taflanna
* Getum ekki b√¶tt vi√∞ f√¶rslu ef v√≠sun er ekki til
* Getum ekki hent f√¶rslu ef √∂nnur v√≠sar √≠ hana
* Mikill kostur og tryggir √∂ryggi gagnanna okkar

***

```sql
CREATE TABLE categories (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255)
);
CREATE TABLE books (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255),
  category INTEGER NOT NULL,
  CONSTRAINT category FOREIGN KEY (category)
    REFERENCES categories (id)
);
```

***

## Many-to-many

* Many-to-many √° vi√∞ √æegar eining √° tenginar √≠ margar a√∞rar einingar
* √û√¶r einingar eiga einnig tengingar √≠ margar a√∞rar einingar
* T.d. nemandi getur veri√∞ skr√°√∞ur √≠ margar √°fanga, √°fangar hafa marga nemendur

***

* Many-to-many tenginar √æurfum vi√∞ a√∞ skilgreina √≠ s√©rst√∂kum _tengit√∂flum_ (e. join table)
* Hver f√¶rsla √≠ tengit√∂flu tengir tv√¶r ra√∞ir √≠ √∂√∞rum t√∂flum
* Getum hugsanlega b√¶tt vi√∞ auka l√Ωsig√∂gnum um sambandi√∞

***

```sql
CREATE TABLE users_books (
  id SERIAL PRIMARY KEY,
  "user" INTEGER NOT NULL,
  book INTEGER NOT NULL,
  rating INTEGER, -- L√Ωsig√∂gn um sambandi√∞!
  CONSTRAINT book FOREIGN KEY (book)
    REFERENCES books (id),
  CONSTRAINT "user" FOREIGN KEY ("user")
    REFERENCES users (id)
);
```

***

## join

* √ûegar vi√∞ viljum f√° g√∂gn √∫r √æessum tengdu t√∂flum √æurfum vi√∞ a√∞ nota _join_
* Sameinar sett √∫r fleiri en einni t√∂flu (e√∞a √∫r s√∂mu t√∂flu) mi√∞a√∞ vi√∞ √°kve√∞in skilyr√∞i
  * ‚ÄûGef√∞u m√©r id og nafn √° b√≥kum √∫r `books` og √æann flokk sem h√∫n tilheyrir √≠ `categories`‚Äú

***

```sql
SELECT
  books.id AS id, books.name AS name,
  categories.name AS category
FROM
  books
JOIN
  -- Taflan sem vi√∞ viljum tengja
  categories ON
    -- Skilyr√∞in √° tengingu
    books.category = categories.id
```

***

* Ver√∞um a√∞ v√≠sa √≠ d√°lka per t√∂flu (`books.id`) √æar sem t√∂flurnar geta √°tt d√°lka me√∞ sama heiti
* `AS` leyfir okkur a√∞ gefa n√Ωtt nafn √≠ ni√∞urst√∂√∞um
* `JOIN` geta or√∞i√∞ fl√≥knari (`left`, `right`, `cross`), f√∂rum ekki n√°nar √≠ √æa√∞ h√©r

***

## n+1 fyrirspurnir

* √ûegar vi√∞ erum a√∞ vinna me√∞ tengd g√∂gn getum vi√∞ dotti√∞ √≠ √æa√∞ ‚Äûanti-pattern‚Äú a√∞ framkv√¶ma `n+1` fyrirspurnir
* `1` fyrirspurn fyrir lista af `n` f√¶rslum, `n` fyrirspurnir til a√∞ f√° g√∂gn um hverja f√¶rslu
* √Üttum alltaf a√∞ geta√∞ nota√∞ join √≠ sta√∞inn, e√∞a m√≥dela√∞ g√∂gnin √æannig a√∞ √æa√∞ √æurfi ekki

***

## D√¶mi

* [join](daemi/ws/join/)
